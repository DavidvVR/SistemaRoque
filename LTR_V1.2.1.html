<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Permisionarios registrados</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f5f5f5; --panel-bg:#fff; --frame-border:#000; --text:#222;
    --font:"Segoe UI", Tahoma, sans-serif; --input-border:#00b8f4;
    --section-bg:#e8e8e8;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:var(--bg);font-family:var(--font);color:var(--text)}
  .hidden{display:none}
  .frame{
    position:relative;margin:40px auto;padding:24px;max-width:920px;
    background:var(--panel-bg);border:4px solid var(--frame-border);border-radius:12px;
  }
  /* Barra / herramientas */
  .list-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:12px}
  .list-actions{display:flex;gap:8px}
  .search{display:flex;gap:8px;align-items:center}
  .search input{padding:8px;border:2px solid var(--input-border);border-radius:8px;min-width:220px}
  .btn{padding:8px 16px;border:2px solid var(--frame-border);background:#e5e5e5;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.primary{border-color:#7c3aed;background:#efe9ff}
  /* Tabla */
  .doc-table-wrapper{border:2px dashed var(--input-border);padding:12px;max-height:320px;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--input-border);padding:8px;text-align:center}
  th{background:#eee}
  td.actions{white-space:nowrap}
  .icon-btn{cursor:pointer;margin:0 4px;font-size:1.1rem}
  .btnDelete{color:#d00}
  .perm-id-link{color:#000;text-decoration:underline;cursor:pointer}
  /* Modal base */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);padding:16px;z-index:1000}
  .modal-content{background:#fff;border:2px solid #000;border-radius:8px;padding:20px;max-width:90vw;max-height:90vh;overflow:auto;position:relative}
  .close{position:absolute;right:10px;top:5px;font-size:1.5rem;cursor:pointer}
</style>
</head>
<body>

<div class="frame">
  <div class="list-toolbar" aria-label="Barra de herramientas">
    <h2>Permisionarios registrados</h2>
    <div class="search">
      <label for="searchPerm">Buscar:</label>
      <input id="searchPerm" type="text" placeholder="Nombre, RFC/INE, ID‚Ä¶" />
    </div>
    <div class="list-actions">
      <button id="btnNuevoPerm" class="btn primary">+ Nuevo Permisionario</button>
      <button id="btnVolver" class="btn">Volver</button>
    </div>
  </div>

  <div class="doc-table-wrapper">
    <table class="doc-table" id="tablaPermisionarios">
      <thead>
        <tr>
          <th>ID Permisionario</th>
          <th>Nombre/Raz√≥n Social</th>
          <th>RFC / INE</th>
          <th>Estatus</th>
          <th>Unidades</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody><!-- filas din√°micas --></tbody>
    </table>
  </div>
</div>

<!-- Modal ver detalle -->
<div id="detallePermModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content">
    <span class="close" title="Cerrar">&times;</span>
    <div id="detallePermContenido"></div>
  </div>
</div>

<!-- Modal confirmaci√≥n eliminar -->
<div id="confirmDeleteModal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-content" style="text-align:center;padding:32px">
    <span class="close" title="Cerrar">&times;</span>
    <p style="margin-bottom:12px">¬øDesea eliminar este permisionario?</p>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="deleteConfirmYes" class="btn primary">S√≠</button>
      <button id="deleteConfirmNo" class="btn">No</button>
    </div>
  </div>
</div>

<script>
/* ====== Store ====== */
const prStoreKey = 'sr_permisionarios';
function getPerms(){ try { return JSON.parse(localStorage.getItem(prStoreKey)) || []; } catch { return []; } }
function setPerms(arr){ localStorage.setItem(prStoreKey, JSON.stringify(arr)); }
function genNextId(arr){
  const prefijo = 'LTR-PR-';
  const maxNum = arr.reduce((max, p) => {
    const m = (p.id || '').match(/^LTR-PR-(\d+)$/);
    const n = m ? parseInt(m[1], 10) : 0;
    return Math.max(max, n);
  }, 0);
  return prefijo + String(maxNum + 1).padStart(2, '0');
}

/* ====== Render ====== */
function renderTabla(filtro=''){
  const tbody = document.querySelector('#tablaPermisionarios tbody');
  const data = getPerms();
  const q = (filtro||'').toLowerCase();

  const fil = data.filter(p =>
    !q ||
    String(p.id||'').toLowerCase().includes(q) ||
    (p.nombre||'').toLowerCase().includes(q) ||
    (p.rfc_ine||'').toLowerCase().includes(q)
  );

  tbody.innerHTML = fil.map(p => `
    <tr>
      <td><span class="perm-id-link" data-id="${p.id}">${p.id||''}</span></td>
      <td>${p.nombre||''}</td>
      <td>${p.rfc_ine||''}</td>
      <td>${p.estatus||'Activo'}</td>
      <td>${p.unidades ?? 0}</td>
      <td class="actions">
        <span class="icon-btn btnView" title="Ver" data-id="${p.id}">üîç</span>
        <span class="icon-btn btnEdit" title="Editar" data-id="${p.id}">‚úèÔ∏è</span>
        <span class="icon-btn btnDelete" title="Eliminar" data-id="${p.id}">üóëÔ∏è</span>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="6">Sin registros</td></tr>`;

  // Listeners por fila
  tbody.querySelectorAll('.btnDelete').forEach(b => b.addEventListener('click', () => openDeleteModal(b.dataset.id)));
  tbody.querySelectorAll('.btnView').forEach(b => b.addEventListener('click', () => verDetalle(b.dataset.id)));
  tbody.querySelectorAll('.btnEdit').forEach(b => b.addEventListener('click', () => editarPerm(b.dataset.id)));
  tbody.querySelectorAll('.perm-id-link').forEach(a => a.addEventListener('click', () => verDetalle(a.dataset.id)));
}

/* ====== Acciones ====== */
// B√∫squeda
document.getElementById('searchPerm').addEventListener('input', e => renderTabla(e.target.value));

// ‚ÄúNuevo‚Äù (placeholder: crea un registro demo; luego lo podr√°s enlazar a tu formulario de Permisionarios)
document.getElementById('btnNuevoPerm').addEventListener('click', () => {
  const arr = getPerms();
  const id = genNextId(arr);
  // Demo m√≠nimo; adapta campos a tu formulario real
  arr.push({
    id,
    nombre: 'Permisionario ' + id,
    rfc_ine: 'XAXX010101000',
    estatus: 'Activo',
    unidades: 1,
    contacto: { nombre: 'Operador', tel: '555-000-0000' },
    comentario: 'Registro de ejemplo'
  });
  setPerms(arr);
  renderTabla(document.getElementById('searchPerm').value);
});

// Volver (cuando lo integres, navega a tu m√≥dulo padre)
document.getElementById('btnVolver').addEventListener('click', () => {
  alert('Integraci√≥n pendiente: aqu√≠ debes regresar al m√≥dulo de Permisionarios.');
});

/* ====== Ver detalle ====== */
const detalleModal = document.getElementById('detallePermModal');
const detalleClose = detalleModal.querySelector('.close');
function verDetalle(id){
  const p = getPerms().find(x => x.id === id);
  if(!p) return;
  const cont = document.getElementById('detallePermContenido');
  cont.innerHTML = `
    <h3 style="margin-bottom:8px;border-bottom:1px solid #000;padding-bottom:4px">Detalle del Permisionario</h3>
    <p><strong>ID:</strong> ${p.id||''}</p>
    <p><strong>Nombre/Raz√≥n Social:</strong> ${p.nombre||''}</p>
    <p><strong>RFC / INE:</strong> ${p.rfc_ine||''}</p>
    <p><strong>Estatus:</strong> ${p.estatus||''}</p>
    <p><strong>Unidades:</strong> ${p.unidades ?? 0}</p>
    <h4 style="margin-top:10px">Contacto</h4>
    <p><strong>Nombre:</strong> ${p.contacto?.nombre ?? ''}</p>
    <p><strong>Tel:</strong> ${p.contacto?.tel ?? ''}</p>
    <h4 style="margin-top:10px">Comentarios</h4>
    <p>${p.comentario || ''}</p>
  `;
  detalleModal.style.display = 'flex';
}
detalleClose.addEventListener('click', () => detalleModal.style.display = 'none');
window.addEventListener('click', e => { if(e.target === detalleModal) detalleModal.style.display = 'none'; });

/* ====== Eliminar ====== */
const confirmDeleteModal = document.getElementById('confirmDeleteModal');
const deleteYes = document.getElementById('deleteConfirmYes');
const deleteNo  = document.getElementById('deleteConfirmNo');
const confirmClose = confirmDeleteModal.querySelector('.close');
let deleteId = null;

function openDeleteModal(id){
  deleteId = id;
  confirmDeleteModal.style.display = 'flex';
}
function closeDeleteModal(){
  deleteId = null;
  confirmDeleteModal.style.display = 'none';
}
deleteYes.addEventListener('click', () => {
  if(deleteId){
    const arr = getPerms();
    const idx = arr.findIndex(p => p.id === deleteId);
    if(idx >= 0){ arr.splice(idx,1); setPerms(arr); }
    renderTabla(document.getElementById('searchPerm').value);
  }
  closeDeleteModal();
});
deleteNo.addEventListener('click', closeDeleteModal);
confirmClose.addEventListener('click', closeDeleteModal);
window.addEventListener('click', e => { if(e.target === confirmDeleteModal) closeDeleteModal(); });

/* ====== Editar (placeholder) ====== */
function editarPerm(id){
  // Aqu√≠ podr√≠as abrir tu formulario de ‚ÄúEditar Permisionario‚Äù y precargar datos.
  alert('Editar ' + id + ' (pendiente de conectar con el formulario de Permisionarios).');
}

/* ====== Seed opcional (si no hay datos) ====== */
(function seedIfEmpty(){
  if(getPerms().length) { renderTabla(); return; }
  const demo = [
    { id:'LTR-PR-01', nombre:'Transportes Luna', rfc_ine:'TLA010101AAA', estatus:'Activo', unidades:3, contacto:{nombre:'Sof√≠a P√©rez',tel:'555-111-2233'}, comentario:'Alta prioritaria' },
    { id:'LTR-PR-02', nombre:'Log√≠stica Rivera', rfc_ine:'LRI020202BBB', estatus:'Inactivo', unidades:0, contacto:{nombre:'Carlos M.',tel:'555-444-5566'}, comentario:'' }
  ];
  setPerms(demo);
  renderTabla();
})();
</script>
</body>
</html>
